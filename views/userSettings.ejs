<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>App settings</title>

    <link rel="stylesheet" href="/stylesheets/userSettings.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-confirm/3.3.2/jquery-confirm.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-confirm/3.3.2/jquery-confirm.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
</head>
<body>
  
  <!-- Modal -->
  <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel" style="font-weight: 900; font-size: 20px;">Modal title</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <h6 style="color: #475569; font-size: 17px; font-weight: 700;">Your current email id:</h6>
                <input type="email" class="form-control" id="Email_id-modal" value="" readonly> 
              </div>
              <p style="color: #ffc107;"><span><i class="bi bi-exclamation-circle-fill"></i></span> a short time otp will be send to your mail-id, do not refresh the page or close the window...</p>
              <div class="send-otp-to-mail d-flex justify-content-center flex-column align-items-center" id="otp-controll-div">
                <button type="button" class="btn btn-primary" id="btn-send-otp">Send OTP</button>

                <div class="form-group justify-content-center align-items-center flex-column d-none" id="verify-div">
                    <input type="number" class="form-control mb-2" value="" id="otp-input" style="text-align: center;"> 
                    <button type="button" class="btn btn-success" id="otp-verify-btn">Verify OTP</button>
                </div>

              </div>
        </div>
      </div>
    </div>
  </div>

  <!-- modal for profile picture... -->
  <div class="modal fade" id="staticBackdrop2" data-backdrop="static" data-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel2" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content" style="background-color: #53C58A;">
        <div class="modal-header" style="border-bottom: 2px solid #cbd5e175;">
          <h5 class="modal-title font-weight-bolder" id="staticBackdropLabel2">Choose your character</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close" id="close_modal">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="character-selection d-flex flex-wrap" style="gap: 10px;">

            <div class="all-character" data-character="/src/Character/chemist.png">
              <img src="/src/Character/chemist.png" alt="Character 1" class="character-image">
            </div>

            <div class="all-character" data-character="/src/Character/courier (1).png">
              <img src="/src/Character/courier (1).png" alt="Character 2" class="character-image">
            </div>

            <div class="all-character" data-character="/src/Character/courier.png">
              <img src="/src/Character/courier.png" alt="Character 2" class="character-image">
            </div>

            <div class="all-character" data-character="/src/Character/diver.png">
              <img src="/src/Character/diver.png" alt="Character 2" class="character-image">
            </div>

            <div class="all-character" data-character="/src/Character/graphic-designer.png">
              <img src="/src/Character/graphic-designer.png" alt="Character 2" class="character-image">
            </div>

            <div class="all-character" data-character="/src/Character/judge.png">
              <img src="/src/Character/judge.png" alt="Character 2" class="character-image">
            </div>

            <div class="all-character" data-character="/src/Character/painter.png">
              <img src="/src/Character/painter.png" alt="Character 2" class="character-image">
            </div>

            <div class="all-character" data-character="/src/Character/pilot.png">
              <img src="/src/Character/pilot.png" alt="Character 2" class="character-image">
            </div>
            
            <div class="all-character" data-character="/src/Character/teacher.png">
              <img src="/src/Character/teacher.png" alt="Character 2" class="character-image">
            </div>
            
            <div class="button-div" id="button-div">
                <input type="file" name="imagesFiles" class="form-control" id="yourCharacter" hidden>
              <img class="img-preloader d-none" id="image-preloader" src="/src/svg/preloader.svg" alt="preloader">
              <button class="button-file" id="button-file"><img src="/src/svg/file.svg" id="selsc-file-icon"></button>
            </div>

        </div>
        </div>
        <div class="modal-footer justify-content-between" style="border-top: 2px solid #cbd5e175;">
          <button type="button" id="Cancel-button" class="btn">Cancel</button>
          <button type="button" id="save-button" class="btn" disabled>Save</button>
        </div>
      </div>
    </div>
  </div>

   <!-- main file start here -->
    <div class="main">
        <% if (typeof alldetails != undefined) { %>
        <nav class="navbar fixed-top navbar-light">
            <a class="navbar-brand" href="/dashboard">
                <i class="bi bi-arrow-left-circle-fill" style="font-size: 18px; color: #fff;"></i>
              </a>
          </nav>

        <div class="card-container">
            <!-- <span class="pro"><svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" viewBox="0 0 10 10" fill="none">
                <circle cx="5" cy="5" r="4.5" fill="#00FF7B" stroke="white"/>
              </svg></span> -->
              <div class="images-containner d-flex justify-content-center align-items-center" id="images-select">
                <% alldetails.forEach((e) => { %>
                    <img class="round" src='<%= (e.profile_picture[0].file_path == './public/uploads') ? '/uploads/' + e.profile_picture[0].file_name : e.profile_picture[0].file_name %>' alt="user">
                <% }); %>
                <div class="overly d-flex justify-content-center align-items-center"><i class="bi bi-pencil-square" style="font-size: 25px; color: #fff;"></i></div>
              </div>
            <div class="form-controller">
                
                <div class="name-edit d-flex justify-content-center align-items-center pt-2 pb-2" data-value="Debayan Bain" id="name-edit-div">
                    <h3 class="mb-0" style="font-weight: 700;"><%= alldetails[0].fullName %></h3>
                    <button type="button" class="edit-btn editable"  id="name-edit-btn"><i class="bi bi-pencil-square" style="font-size: 15px; color: #fff;"></i></button>
                </div>

                <div class="email-edit d-flex justify-content-center align-items-center pt-2 pb-2"  data-Useremail="debayanbain@gmail.com" id="email-edit-div">
                    <h6 class="mb-0"><%= alldetails[0].email_id %></h6>
                    <button type="button" class="edit-btn editable" id="email-edit-btn"><i class="bi bi-pencil-square" style="font-size: 15px; color: #fff;"></i></button>
                </div>
                
                <div class="password-edit d-flex justify-content-center align-items-center pt-2 pb-2">
                    <h6>Change Password</h6>
                    <button type="button" id="password-edit-btn"><i class="bi bi-pencil-square" style="font-size: 15px; color: #fff;"></i></button>
                </div>

                <div class="delete-account">
                    <button type="button" class="btn btn-danger btn-lm mb-2">Delete account</button>
                </div>
            </div>
        </div>
        <% } %>
    </div>
    

   
    <script type="text/javascript" src="https://smtpjs.com/v3/smtp.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.2/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha512-z4OUqw38qNLpn1libAN9BsoDx6nbNFio5lA6CuTp9NlK83b89hgyCVq+N5FdBJptINztxn1Z3SaKSKUS5UP60Q==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-confirm/3.3.2/jquery-confirm.min.js"></script>

    <script>
       $(document).ready(function () {
        const notyf = new Notyf({
            position: {
            x: 'center',
            y: 'top',
        }
        });
    $(document).on('click', '#name-edit-btn', function () {
        let userEmail = $('#email-edit-div').attr('data-Useremail');
        if (!$('#name-edit-div').hasClass('editing')) {
            let currentData = $('.name-edit h3').text();
            let createInput = $(`<input type="text" class="form-control" name="edit_name" value="${currentData}">`);
            createInput.css('width', '80%');
            $('#name-edit-div').html('');
            $('#name-edit-div').addClass('editing');
            $('#name-edit-div').append(createInput);
            createInput.focus();
            createInput.select()
            createInput.blur(function () {
                let newval = $(this).val();
            
                if (newval.trim() === '') {
                    notyf.error({
                        message: 'Name field is not to be empty!',
                        duration: 5000
                    })
                    resetEdit();
                    return false;
                }else if(newval.length <= 3){
                    notyf.error({
                        message: 'Name is not less then 3 character!',
                        duration: 5000
                    })
                    resetEdit();
                    return false;
                }else if(currentData === newval){
                    resetEdit();
                    return false;
                }else{
                    $('#name-edit-div').html('');
                    $('#name-edit-div').removeClass('editing');
                    let createHtag = $(`<h3 class="mb-0" style="font-weight: 700;"> ${newval} </h3>`);
                    let createButton = $(` <button type="button" class="edit-btn editable"  id="name-edit-btn"><i class="bi bi-pencil-square" style="font-size: 15px; color: #fff;"></i></button>`);
                    $('#name-edit-div').append(createHtag);
                    $('#name-edit-div').append(createButton);
                    updateTodatabase(newval, userEmail);
                }
            });
        }
    });

    //For email .........
    $('#email-edit-div').click(function (e) {
        e.preventDefault();
        let emailvalue = $('.email-edit h6').text();
        $('#Email_id-modal').val(emailvalue);
        $('#exampleModal').modal('show');

         
        $("#btn-send-otp").click(function () {
            let otp = generateOTP();
            let otpExpirationTime = Date.now() + 60 * 1000;      
            Email.send({
                SecureToken : "fe691a97-f89a-4004-ac9b-26dbd51dde76",
                To : 'rifejen563@mugadget.com',
                From : "ancientperiod20@gmail.com",
                Subject : "Verify your email",
                Body : `<!DOCTYPE html>
                                <html lang="en">
                                <head>
                                        <meta charset="UTF-8">
                                        <meta name="viewport" content="width=device-width, initial-scale=1.0">

                                        <style>
                                            @import url('https://fonts.googleapis.com/css2?family=Nunito:ital,wght@0,400;0,500;0,600;0,700;0,800;0,900;0,1000;1,400;1,500;1,600;1,700;1,800;1,900;1,1000&display=swap');
                                            *{
                                                padding: 0px;
                                                margin: 0px;
                                                box-sizing: border-box;
                                                font-family: 'Nunito', sans-serif;
                                            }
                                            .main-div-temp{
                                                display: flex;
                                                justify-content: center;
                                                align-items: center;
                                                flex-direction: column;
                                            }
                                            .main-div-temp h1 span{
                                                color: #ffc107;
                                                font-style: italic;
                                            }
                                            .main-div-temp p{
                                                font-size: 15px;
                                                font-weight: 600;
                                                text-align: center;
                                            }
                                            .otp-container{
                                                display: flex;
                                                justify-content: center;
                                                align-items:center;
                                                margin-top: 4rem;
                                                width: 100%;
                                                background-color: #2ecc71;
                                                height: 200px;flex-direction: column;
                                                gap: 10px;
                                            }
                                            .otp-container h2{
                                                color: #3c3a3a;
                                                font-size: 25px;
                                            }
                                            .otp-container p{
                                                background-color: #ffc107;
                                                padding: 10px;
                                                border-radius: 8px;
                                                color: #fff;
                                                font-size: 25px;
                                            }
                                            .last-div{
                                                margin-top: 5rem;
                                            }
                                            .last-div h6{
                                                font-size: 14px;
                                                text-align: center;
                                                color: #3c3a3aad;
                                            }
                                        </style>
                                    </head>
                                    <body>
                                        <div class="main-div-temp">
                                            <h1>Hello from <span>ECOchat</span></h1>
                                            <p>Thanks for using Ecochat appllication, <br> we are happy to help you out.ðŸ¤©</p>

                                            <div class="otp-container">
                                                <h2>Your one tome password(OTP) is ðŸ‘‰</h2>
                                                <p>${otp}</p>
                                            </div>

                                            <div class="last-div">
                                                <h6>Please use the following OTP to change your eamil id. <br>
                                                    Do not share this OTP with anyone. <br> If this is not you, please ignore this email or contact <br> our customer service center</h6>
                                            </div>
                                        </div>
                                    </body>
                                    </html>`,
                }).then(
                message => {
                    if (message === 'OK') {
                        $.alert({
                        title: 'Alert!',
                        content: `An email has been send to your ${emailvalue} mailbox`,
                    });
                            $('#btn-send-otp').addClass('d-none');
                            $('#verify-div').addClass('d-flex');
                            $('#verify-div').removeClass('d-none');
                    }
                });
                $('#otp-verify-btn').click(function () {
                   if ($('#otp-input').val() === otp) {
                    if (otpExpirationTime && Date.now() <= otpExpirationTime) {
                        let createEmail = $(`<input type="email" class="form-control mb-2" name="email_save" placeholder="Enter new email id" id="update-emailid">
                    <input type="email" class="form-control mb-2" name="cnfirm_emails" placeholder="Confirm new email id" id="confirm-emailid">
                    <button type="button" class="btn btn-primary" id="save-update-mail">Save</button>`);
                    $('#verify-div').html('');
                    $('#verify-div').html(createEmail);
                }else{
                    notyf.error({
                        message: 'OTP has been expired...',
                        duration: 5000
                    });
                    return false;
                }
                   } else {
                    notyf.error({
                        message: 'OTP is not valid, try again!',
                        duration: 5000
                    });
                    return false;
                   }
                });

                $(document).on('click','#save-update-mail',function () {
                    let validEmail = $('#update-emailid').val();
                    let conEmail = $('#confirm-emailid').val();
                    let emailRegex = /^[\w-\.]+@([\w-]+\.)+[\w-]{2,4}$/;

                    if (!emailRegex.test(validEmail) || validEmail === '') {
                        notyf.error({
                        message: 'Enter a valid email-id like @, .com without leave empty...',
                        duration: 5000
                    });
                    return false;
                    }else if(validEmail != conEmail){
                        notyf.error({
                        message: 'Email not match...',
                        duration: 5000
                    });
                    return false;
                    }else{
                    EmailUpdateDatabase(validEmail, emailvalue);
                    return true;
                    }
                   })
        });
    });


    function generateOTP() {
    return Math.floor(100000 + Math.random() * 900000).toString();
    }

    //Rest the input 
    function resetEdit() {
        let defaultName = $('#name-edit-div').data('value');
        $('#name-edit-div').html('');
        $('#name-edit-div').removeClass('editing');
        let createHtag = $(`<h3 class="mb-0" style="font-weight: 700;"> ${defaultName} </h3>`); // Reset to the original text
        let createButton = $(` <button type="button" class="edit-btn editable"  id="name-edit-btn"><i class="bi bi-pencil-square" style="font-size: 15px; color: #fff;"></i></button>`);
        $('#name-edit-div').append(createHtag);
        $('#name-edit-div').append(createButton);
    }

    function updateTodatabase(data, email) {
        let name ={
            name:data,
            userEmail: email
        }
        $.ajax({
            url: '/update',
            method: 'POST',
            data: name
        }).then((result) => {
            notyf.success({
             message: result.message,
             duration: 5000
            });
            location.reload();
        }).catch((err) => {
            notyf.error({
             message: err.responseJSON.error,
             duration: 5000
            }); 
        });
    }

    function EmailUpdateDatabase(newemails, Oldemail) {
        let data = {
            email: newemails,
            Oldemail: Oldemail
        }

        $.ajax({
            url: '/update',
            method: 'POST',
            data: data,
        }).then((data) => {
            notyf.success({
             message: data.message,
             duration: 5000
            });
            location.reload();                        
        }).catch((err) => {
            console.log(err.responseJSON.error);
            notyf.error({
             message: err.responseJSON.error,
             duration: 5000
            }); 
        });
    }
});

$(document).ready(function () {
    const notyf = new Notyf({
            position: {
            x: 'center',
            y: 'top',
        }
        });
    let selectedData;

    $('#images-select').on('click', function () {
            $('#staticBackdrop2').modal('show');
    })

    $('.all-character').click(function(){
        restForCharacter();
        $(".all-character").css('border', "3px solid #f8f9fa");
        $(this).css('border', '3px solid #fec347');
        selectedData = $(this).data('character');
        $('#save-button').prop('disabled', false);
        $('#save-button').css('cursor', 'pointer');
    });

    $('#button-file').click(function () {
        $(yourCharacter).click();
        $(".all-character").css('border', "3px solid #f8f9fa");
        $(yourCharacter).on('change', function (e) {
            let outputIMG = $('#selsc-file-icon');
            let imagesFile = e.target.files[0];
            let imagesValidation  = ['image/png', 'image/jpeg', 'image/jpg']
            if (imagesFile && imagesValidation.indexOf(imagesFile.type) === -1) {
                resetFunction();
                console.log(imagesFile)
                return;
            }else if(imagesFile && imagesFile.size <= 5242880){
                outputIMG.prop('hidden', true);
                $('#image-preloader').removeClass('d-none');
                selectedData = imagesFile;
                let reader = new FileReader();
                reader.readAsDataURL(imagesFile);
                reader.onload = (e)=>{
                    let result = e.target.result;
                    outputIMG.prop('src', result);
                    $('#image-preloader').addClass('d-none');
                    outputIMG.prop('hidden', false);
                    $('#save-button').prop('disabled', false);
                    $('#save-button').css('cursor', 'pointer');
                }
            }else{
            notyf.error({
              message: 'File size should be less then or equal 5MB...',
              duration: 5000
            })
            return;
          }
        })
    });

    $('#save-button').on('click', function () {
    let userEmailID = $('#email-edit-div').attr('data-Useremail');
    let formData = new FormData();
    if (typeof selectedData === 'string') {
        formData.append('characterUrl', selectedData);
        formData.append("emailID", userEmailID);
        updateImages(formData);
    } else if (selectedData instanceof File) {
        formData.append('image', selectedData);
        formData.append("emailID", userEmailID); // Corrected the typo
        updateImages(formData);
    }
});


    $('#Cancel-button').on("click", function () {
        $.confirm({
        title: 'Warning !',
        content: 'Your changes will remove, are you sure you continue',
        draggable: true,
        type: 'orange',
        typeAnimated: true,
        autoClose: 'close|10000',
        buttons: {
        Yes: {
            btnClass: 'btn-orange',
            action: function(){
                location.reload();
            }
        },
        close: function () {
        }
    }
    });
    });

    function updateImages(data) {
        $.ajax({
            url: '/update',
            method: 'POST',
            data: data,
            processData: false, // Prevent jQuery from processing the data
            contentType: false, // Prevent jQuery from setting content type
        }).then((response) => {
            console.log(response, "responce")
            notyf.success({
                message: response.message,
                duration: 5000
            });
            setTimeout(function () {
                location.reload();
            }, 2000);
        }).catch((error) => {
            console.log(error, "error");
            notyf.error({
              message: 'something went wrong, please try after sometime...',
              duration: 5000
            })
        });
    }

    $(document).on("click", function (e) {
        if ($('#staticBackdrop2').is(e.target)) {  // user click outside the modal then the modal will closed...
            $("#staticBackdrop2").modal('hide');
        }
    });

    function resetFunction() {
        $('#yourCharacter').val("");
        $('#selsc-file-icon').prop('src', '/src/svg/file.svg');
          $('#save-button').prop('disabled', true);
          $('#save-button').css('cursor', 'no-drop');
          $('.all-character').css('border', '3px solid #f8f9fa');
    }
    function restForCharacter() {
        $('#yourCharacter').val("");
        $('#selsc-file-icon').prop('src', '/src/svg/file.svg');
          $('#save-button').prop('disabled', true);
          $('#save-button').css('cursor', 'no-drop');
          $('.all-character').css('border', '3px solid #f8f9fa');
    }
});

    </script>
</body>
</html>